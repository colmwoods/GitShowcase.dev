{% load extra_tags %}

<div class="repo-card">
    <div class="repo-header">
        {% if bookmark %}
        <h3><a href="{{ bookmark.repo_url }}" target="_blank">{{ bookmark.repo_name }}</a></h3>
        <div class="repo-stats">
            â­ {{ bookmark.stargazers_count|default:0 }} | ğŸ´ {{ bookmark.forks_count|default:0 }}
        </div>
        {% elif repo %}
        <h3><a href="{{ repo.html_url }}" target="_blank">{{ repo.name }}</a></h3>
        <div class="repo-stats">
            â­ {{ repo.stargazers_count|default:0 }} | ğŸ´ {{ repo.forks_count|default:0 }}
        </div>
        {% endif %}
    </div>

    {% if repo and repo.description %}
    <p>{{ repo.description }}</p>
    {% elif bookmark and bookmark.description %}
    <p>{{ bookmark.description }}</p>
    {% endif %}

    <div class="repo-footer">
        <span class="badge">
            {% if bookmark %}
            {{ bookmark.language|default:"Unknown" }}
            {% elif repo %}
            {{ repo.language|default:"Unknown" }}
            {% endif %}
        </span>

        {% if repo and repo.updated_at %}
        <small>ğŸ•’ Updated: {{ repo.updated_at|date:"M d, Y" }}</small>
        {% elif bookmark %}
        <small>ğŸ“… Bookmarked: {{ bookmark.created_at|date:"M d, Y" }}</small>
        {% endif %}
    </div>

    <div class="repo-actions">
        {% if repo %}
        <a href="{{ repo.html_url }}" target="_blank" class="btn-action view">ğŸ”— View</a>
        <a href="{{ repo.html_url }}/archive/refs/heads/{{ repo.default_branch|default:'main' }}.zip"
            class="btn-action download">â¬‡ï¸ Download</a>
        <a href="{{ repo.html_url }}/fork" target="_blank" class="btn-action fork">ğŸ´ Fork</a>

        {% if user.is_authenticated %}
        {% if repo.full_name|lower in starred_repos %}
        <button class="btn-action star starred" data-repo="{{ repo.full_name }}">
            â­ Starred
        </button>
        {% else %}
        <button class="btn-action star" data-repo="{{ repo.full_name }}">
            â­ Star
        </button>
        {% endif %}
        {% else %}
        <a href="{% url 'account_login' %}" class="btn-action star">
            â­ Star
        </a>
        {% endif %}

        <form method="post" action="{% url 'add_bookmark' %}" style="display:inline;">
            {% csrf_token %}
            <input type="hidden" name="repo_name" value="{{ repo.name }}">
            <input type="hidden" name="repo_url" value="{{ repo.html_url }}">
            <input type="hidden" name="language" value="{{ repo.language }}">
            <input type="hidden" name="description" value="{{ repo.description }}">
            <input type="hidden" name="stargazers_count" value="{{ repo.stargazers_count }}">
            <input type="hidden" name="forks_count" value="{{ repo.forks_count }}">
            <button type="submit" class="btn-action bookmark">ğŸ”– Bookmark</button>
        </form>

        {% elif bookmark %}
        <a href="{{ bookmark.repo_url }}" target="_blank" class="btn-action view">ğŸ”— View</a>
        <a href="{{ bookmark.repo_url }}/archive/refs/heads/main.zip" class="btn-action download">â¬‡ï¸ Download</a>
        <a href="{{ bookmark.repo_url }}/fork" target="_blank" class="btn-action fork">ğŸ´ Fork</a>
        {% if user.is_authenticated %}
        {% with repo_full_name=bookmark.repo_url|cut:'https://github.com/' %}
        {% if repo.full_name|lower in starred_repos %}
        <button class="btn-action star starred" data-repo="{{ repo_full_name }}">
            â­ Starred
        </button>
        {% else %}
        <button class="btn-action star" data-repo="{{ repo_full_name }}">
            â­ Star
        </button>
        {% endif %}
        {% endwith %}
        {% else %}
        <a href="{% url 'account_login' %}" class="btn-action star">
            â­ Star
        </a>
        {% endif %}


        {% if bookmark.id %}
        <form method="post" action="{% url 'delete_bookmark' bookmark.id %}" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="btn-action delete">ğŸ—‘ï¸ Remove</button>
        </form>
        {% endif %}
        {% endif %}

        {% if user.is_authenticated %}
        <button type="button" class="btn-action comment" data-bs-toggle="modal" data-bs-target="#commentModal"
            data-repo="{% if bookmark %}{{ bookmark.repo_name }}{% else %}{{ repo.name }}{% endif %}"
            data-url="{% if bookmark %}{{ bookmark.repo_url }}{% else %}{{ repo.html_url }}{% endif %}">
            ğŸ’¬ Comment
        </button>
        {% endif %}
    </div>

    <!-- âœ… COMMENTS (always show bubble, even if 0) -->
    {% if bookmark %}
    {% with repo_comments=comments_by_repo|get_item:bookmark.repo_name %}
    <div class="repo-comments-container">
        <button class="toggle-comments-btn btn btn-sm btn-outline-secondary"
            data-target="comments-{{ forloop.counter }}">
            ğŸ’¬ {{ repo_comments|length|default:0 }} Comment{{ repo_comments|pluralize }}
        </button>
        <div class="repo-comments" id="comments-{{ forloop.counter }}" style="display:none;">
            <ul class="list-unstyled repo-comment-list" style="margin-top:0.5rem;">
                {% if repo_comments %}
                {% for comment in repo_comments %}
                <li class="comment-item"
                    style="margin-bottom:0.6rem;border-bottom:1px solid #222;padding-bottom:0.4rem;">
                    {% with github=comment.user.socialaccount_set.first %}
                    <div style="display:flex; align-items:center; gap:0.4rem;">
                        {% if github %}
                        <img src="{{ github.extra_data.avatar_url }}" alt="Avatar"
                            style="width:24px; height:24px; border-radius:50%;">
                        {% endif %}
                        <small>
                            <strong style="color:#00bfff;">
                                {{ github.extra_data.login|default:comment.user.username }}
                            </strong> â€”
                            {{ comment.created_at|date:"M d, Y H:i" }}
                        </small>
                    </div>
                    {% endwith %}
                    <div style="margin-top:0.25rem;">{{ comment.body }}</div>

                    {% if user == comment.user %}
                    <div class="comment-actions" style="margin-top:0.2rem; display:flex; gap:0.25rem;">
                        <a href="{% url 'edit_comment' comment.id %}" class="btn btn-outline-info btn-edit"
                            style="font-size:0.75rem; padding:0.15rem 0.4rem; line-height:1;">
                            âœï¸ Edit
                        </a>
                        <button class="btn btn-outline-danger btn-delete" data-comment_id="{{ comment.id }}"
                            style="font-size:0.75rem; padding:0.15rem 0.4rem; line-height:1;">
                            ğŸ—‘ï¸ Delete
                        </button>
                    </div>
                    {% endif %}
                </li>
                {% endfor %}
                {% else %}
                <li class="text-muted" style="margin-top:0.4rem;">No comments yet.</li>
                {% endif %}
            </ul>
        </div>
    </div>
    {% endwith %}

    {% elif repo %}
    {% with repo_comments=comments_by_repo|get_item:repo.name %}
    <div class="repo-comments-container">
        <button class="toggle-comments-btn btn btn-sm btn-outline-secondary"
            data-target="comments-{{ forloop.counter }}">
            ğŸ’¬ {{ repo_comments|length|default:0 }} Comment{{ repo_comments|pluralize }}
        </button>
        <div class="repo-comments" id="comments-{{ forloop.counter }}" style="display:none;">
            <ul class="list-unstyled repo-comment-list" style="margin-top:0.5rem;">
                {% if repo_comments %}
                {% for comment in repo_comments %}
                <li class="comment-item"
                    style="margin-bottom:0.6rem;border-bottom:1px solid #222;padding-bottom:0.4rem;">
                    {% with github=comment.user.socialaccount_set.first %}
                    <div style="display:flex; align-items:center; gap:0.4rem;">
                        {% if github %}
                        <img src="{{ github.extra_data.avatar_url }}" alt="Avatar"
                            style="width:24px; height:24px; border-radius:50%;">
                        {% endif %}
                        <small>
                            <strong style="color:#00bfff;">
                                {{ github.extra_data.login|default:comment.user.username }}
                            </strong> â€”
                            {{ comment.created_at|date:"M d, Y H:i" }}
                        </small>
                    </div>
                    {% endwith %}
                    <div style="margin-top:0.25rem;">{{ comment.body }}</div>

                    {% if user == comment.user %}
                    <div class="comment-actions" style="margin-top:0.2rem; display:flex; gap:0.25rem;">
                        <a href="{% url 'edit_comment' comment.id %}" class="btn btn-outline-info btn-edit"
                            style="font-size:0.75rem; padding:0.15rem 0.4rem; line-height:1;">
                            âœï¸ Edit
                        </a>
                        <button class="btn btn-outline-danger btn-delete" data-comment_id="{{ comment.id }}"
                            style="font-size:0.75rem; padding:0.15rem 0.4rem; line-height:1;">
                            ğŸ—‘ï¸ Delete
                        </button>
                    </div>
                    {% endif %}
                </li>
                {% endfor %}
                {% else %}
                <li class="text-muted" style="margin-top:0.4rem;">No comments yet.</li>
                {% endif %}
            </ul>
        </div>
    </div>
    {% endwith %}
    {% endif %}
</div>