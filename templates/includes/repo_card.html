{% load extra_tags %}
<div class="repo-card">
    <div class="repo-header">
        <h3>
            <a href="{{ repo.html_url|default:bookmark.repo_url }}" target="_blank">
                {{ repo.name|default:bookmark.repo_name }}
            </a>
        </h3>
        {% if repo.stargazers_count %}
        <div class="repo-stats">
            â­ {{ repo.stargazers_count }} | ğŸ´ {{ repo.forks_count }}
        </div>
        {% endif %}
    </div>

    {% if repo.description %}
    <p>{{ repo.description }}</p>
    {% elif bookmark.notes %}
    <p>{{ bookmark.notes }}</p>
    {% else %}
    <p><em>No description available.</em></p>
    {% endif %}

    <div class="repo-footer">
        {% if repo.language %}
        <span class="badge">{{ repo.language }}</span>
        {% endif %}
        {% if repo.updated_at %}
        <small>ğŸ•’ Updated: {{ repo.updated_at|date:"M d, Y" }}</small>
        {% elif bookmark.created_at %}
        <small>ğŸ“… Bookmarked on: {{ bookmark.created_at|date:"M d, Y" }}</small>
        {% endif %}
    </div>

    <div class="repo-actions">
        {% if repo.html_url %}
        <a href="{{ repo.html_url }}" target="_blank" class="btn-action view">ğŸ”— View</a>
        <a href="{{ repo.html_url }}/archive/refs/heads/{{ repo.default_branch }}" class="btn-action download">
            â¬‡ï¸ Download
        </a>
        <a href="{{ repo.html_url }}/fork" target="_blank" class="btn-action fork">ğŸ´ Fork</a>
        <button class="btn-action star" data-repo="{{ repo.full_name }}">â­ Star</button>
        {% endif %}

        {% if not is_bookmark_page %}
        <form method="post" action="{% url 'add_bookmark' %}" style="display:inline;">
            {% csrf_token %}
            <input type="hidden" name="repo_name" value="{{ repo.name }}">
            <input type="hidden" name="repo_url" value="{{ repo.html_url }}">
            <button type="submit" class="btn-action bookmark">ğŸ”– Bookmark</button>
        </form>
        {% else %}
        <form method="post" action="{% url 'delete_bookmark' bookmark.id %}" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="btn-action delete">ğŸ—‘ï¸ Remove</button>
        </form>
        {% endif %}
        <button type="button" class="btn-action comment" data-bs-toggle="modal" data-bs-target="#commentModal"
            data-repo="{{ repo.name|default:bookmark.repo_name }}"
            data-url="{{ repo.html_url|default:bookmark.repo_url }}">
            ğŸ’¬ Comment
        </button>
    </div>
    {% if not is_bookmark_page %}
    {% with repo_comments=comments_by_repo|get_item:repo.name %}
    {% if repo_comments %}
    <div class="repo-comments-container">
        <button class="toggle-comments-btn btn btn-sm btn-outline-secondary"
            data-target="comments-{{ forloop.counter }}">
            ğŸ’¬ {{ repo_comments|length }} Comment{{ repo_comments|pluralize }}
        </button>
        <div class="repo-comments" id="comments-{{ forloop.counter }}" style="display: none;">
            <ul class="list-unstyled repo-comment-list" style="margin-top: 0.5rem;">
                {% for comment in repo_comments %}
                <li class="comment-item"
                    style="margin-bottom: 0.6rem; border-bottom: 1px solid #222; padding-bottom: 0.4rem;">
                    <small>
                        <strong style="color:#00bfff;">{{ comment.user.username }}</strong>
                        â€” {{ comment.created_at|date:"M d, Y H:i" }}
                    </small>
                    <div style="margin-top: 0.25rem;">{{ comment.body }}</div>

                    {% if user == comment.user %}
                    <div class="mt-1">
                        <a href="{% url 'edit_comment' comment.id %}" class="btn btn-sm btn-outline-info btn-edit"
                            data-comment_id="{{ comment.id }}">
                            âœï¸ Edit
                        </a>
                        <button class="btn btn-sm btn-outline-danger btn-delete" data-comment_id="{{ comment.id }}">
                            ğŸ—‘ï¸ Delete
                        </button>
                    </div>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}
    {% endwith %}
    {% endif %}
</div>