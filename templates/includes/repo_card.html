{% load extra_tags %}

<div class="repo-card">
    <div class="repo-header">
        {% if bookmark %}
        <h3><a href="{{ bookmark.repo_url }}" target="_blank">{{ bookmark.repo_name }}</a></h3>
        <div class="repo-stats">
            â­ {{ bookmark.stargazers_count|default:0 }} | ğŸ´ {{ bookmark.forks_count|default:0 }}
        </div>
        {% elif repo %}
        <h3><a href="{{ repo.html_url }}" target="_blank">{{ repo.name }}</a></h3>
        <div class="repo-stats">
            â­ {{ repo.stargazers_count|default:0 }} | ğŸ´ {{ repo.forks_count|default:0 }}
        </div>
        {% endif %}
    </div>

    {% if repo and repo.description %}
    <p>{{ repo.description }}</p>
    {% elif bookmark and bookmark.description %}
    <p>{{ bookmark.description }}</p>
    {% endif %}

    <div class="repo-footer">
        <span class="badge">
            {% if bookmark %}
            {{ bookmark.language|default:"Unknown" }}
            {% elif repo %}
            {{ repo.language|default:"Unknown" }}
            {% endif %}
        </span>

        {% if repo and repo.updated_at %}
        <small>ğŸ•’ Updated: {{ repo.updated_at|date:"M d, Y" }}</small>
        {% elif bookmark %}
        <small>ğŸ“… Bookmarked: {{ bookmark.created_at|date:"M d, Y" }}</small>
        {% endif %}
    </div>

    <div class="repo-actions">
        {% if repo %}
        <a href="{{ repo.html_url }}" target="_blank" class="btn-action view">ğŸ”— View</a>
        <a href="{{ repo.html_url }}/archive/refs/heads/{{ repo.default_branch|default:'main' }}.zip"
            class="btn-action download">â¬‡ï¸ Download</a>
        <a href="{{ repo.html_url }}/fork" target="_blank" class="btn-action fork">ğŸ´ Fork</a>
        <button class="btn-action star" data-repo="{{ repo.full_name }}">â­ {{ repo.stargazers_count }}</button>

        <form method="post" action="{% url 'add_bookmark' %}" style="display:inline;">
            {% csrf_token %}
            <input type="hidden" name="repo_name" value="{{ repo.name }}">
            <input type="hidden" name="repo_url" value="{{ repo.html_url }}">
            <input type="hidden" name="language" value="{{ repo.language }}">
            <input type="hidden" name="description" value="{{ repo.description }}">
            <input type="hidden" name="stargazers_count" value="{{ repo.stargazers_count }}">
            <input type="hidden" name="forks_count" value="{{ repo.forks_count }}">
            <button type="submit" class="btn-action bookmark">ğŸ”– Bookmark</button>
        </form>

        {% elif bookmark %}
        <a href="{{ bookmark.repo_url }}" target="_blank" class="btn-action view">ğŸ”— View</a>
        <a href="{{ bookmark.repo_url }}/archive/refs/heads/main.zip" class="btn-action download">â¬‡ï¸ Download</a>
        <a href="{{ bookmark.repo_url }}/fork" target="_blank" class="btn-action fork">ğŸ´ Fork</a>
        <button class="btn-action star" data-repo="{{ bookmark.repo_url|cut:'https://github.com/' }}">
            â­ {{ bookmark.stargazers_count|default:0 }}
        </button>

        {% if bookmark.id %}
        <form method="post" action="{% url 'delete_bookmark' bookmark.id %}" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="btn-action delete">ğŸ—‘ï¸ Remove</button>
        </form>
        {% endif %}
        {% endif %}

        <button type="button" class="btn-action comment" data-bs-toggle="modal" data-bs-target="#commentModal"
            data-repo="{% if bookmark %}{{ bookmark.repo_name }}{% else %}{{ repo.name }}{% endif %}"
            data-url="{% if bookmark %}{{ bookmark.repo_url }}{% else %}{{ repo.html_url }}{% endif %}">
            ğŸ’¬ Comment
        </button>
    </div>

    {% if bookmark %}
    {% with repo_comments=comments_by_repo|get_item:bookmark.repo_name %}
    {% if repo_comments %}
    <div class="repo-comments-container">
        <button class="toggle-comments-btn btn btn-sm btn-outline-secondary"
            data-target="comments-{{ forloop.counter }}">
            ğŸ’¬ {{ repo_comments|length }} Comment{{ repo_comments|pluralize }}
        </button>
        <div class="repo-comments" id="comments-{{ forloop.counter }}" style="display:none;">
            <ul class="list-unstyled repo-comment-list" style="margin-top:0.5rem;">
                {% for comment in repo_comments %}
                <li class="comment-item"
                    style="margin-bottom:0.6rem;border-bottom:1px solid #222;padding-bottom:0.4rem;">
                    <small><strong style="color:#00bfff;">{{ comment.user.username }}</strong> â€”
                        {{ comment.created_at|date:"M d, Y H:i" }}</small>
                    <div style="margin-top:0.25rem;">{{ comment.body }}</div>
                    {% if user == comment.user %}
                    <div class="mt-1">
                        <a href="{% url 'edit_comment' comment.id %}" class="btn btn-sm btn-outline-info btn-edit">âœï¸
                            Edit</a>
                        <button class="btn btn-sm btn-outline-danger btn-delete" data-comment_id="{{ comment.id }}">ğŸ—‘ï¸
                            Delete</button>
                    </div>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}
    {% endwith %}
    {% elif repo %}
    {% with repo_comments=comments_by_repo|get_item:repo.name %}
    {% if repo_comments %}
    <div class="repo-comments-container">
        <button class="toggle-comments-btn btn btn-sm btn-outline-secondary"
            data-target="comments-{{ forloop.counter }}">
            ğŸ’¬ {{ repo_comments|length }} Comment{{ repo_comments|pluralize }}
        </button>
        <div class="repo-comments" id="comments-{{ forloop.counter }}" style="display:none;">
            <ul class="list-unstyled repo-comment-list" style="margin-top:0.5rem;">
                {% for comment in repo_comments %}
                <li class="comment-item"
                    style="margin-bottom:0.6rem;border-bottom:1px solid #222;padding-bottom:0.4rem;">
                    <small><strong style="color:#00bfff;">{{ comment.user.username }}</strong> â€”
                        {{ comment.created_at|date:"M d, Y H:i" }}</small>
                    <div style="margin-top:0.25rem;">{{ comment.body }}</div>
                    {% if user == comment.user %}
                    <div class="mt-1">
                        <a href="{% url 'edit_comment' comment.id %}" class="btn btn-sm btn-outline-info btn-edit">âœï¸
                            Edit</a>
                        <button class="btn btn-sm btn-outline-danger btn-delete" data-comment_id="{{ comment.id }}">ğŸ—‘ï¸
                            Delete</button>
                    </div>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}
    {% endwith %}
    {% endif %}
</div>